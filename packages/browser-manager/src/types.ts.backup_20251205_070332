/**
 * packages/browser-manager/src/types.ts
 * 監査対応版 - プロセス追跡と階層管理を強化
 */

import type { Browser, BrowserContext, Page } from 'playwright';

export type PID = number;

export interface ProcessInfo {
  pid: PID;
  launchedAt: number;
  browserType: 'chromium' | 'firefox' | 'webkit';
  parentPid?: PID;
  command: string;
  rss?: number; // Resident Set Size in KB
}

export interface BrowserRecord {
  id: string;
  browser: Browser;
  processInfo: ProcessInfo;
  contexts: Map<string, ContextRecord>; // コンテキストID -> ContextRecord
  createdAt: number;
  lastUsedAt: number;
  requestCount: number;
  isHealthy: boolean;
}

export interface ContextRecord {
  id: string;
  context: BrowserContext;
  browserId: string;
  pages: Map<string, PageRecord>;
  createdAt: number;
  lastUsedAt: number;
  requestCount: number;
  isActive: boolean;
  isDisposed: boolean;
}

export interface PageRecord {
  id: string;
  page: Page;
  contextId: string;
  browserId: string;
  createdAt: number;
  lastUsedAt: number;
}

export interface RecyclingPolicy {
  maxIdleTimeMs: number;
  maxRequestsPerContext: number;
  maxContextsPerBrowser: number;
  maxBrowserAgeMs: number;
  healthCheckIntervalMs: number;
  memoryThresholdMB: number;
}

export interface ResourcePoolStats {
  totalBrowsers: number;
  totalContexts: number;
  totalPages: number;
  activeContexts: number;
  idleContexts: number;
  totalRequests: number;
  memoryUsage: {
    totalRSS: number;
    maxRSS: number;
    avgRSS: number;
  };
  zombieProcesses: number;
}

export interface AcquireContextOptions {
  requireCleanContext?: boolean;
  reuseExisting?: boolean;
  timeoutMs?: number;
  browserType?: 'chromium' | 'firefox' | 'webkit';
}

export interface CleanupOptions {
  level: 'gentle' | 'normal' | 'aggressive' | 'nuclear';
  forceKillProcesses: boolean;
  timeoutMs: number;
}

export const DEFAULT_RECYCLING_POLICY: RecyclingPolicy = {
  maxIdleTimeMs: 10 * 60 * 1000, // 10分
  maxRequestsPerContext: 100,
  maxContextsPerBrowser: 5,
  maxBrowserAgeMs: 60 * 60 * 1000, // 1時間
  healthCheckIntervalMs: 30 * 1000, // 30秒
  memoryThresholdMB: 500,
};

export const DEFAULT_CLEANUP_OPTIONS: CleanupOptions = {
  level: 'normal',
  forceKillProcesses: true,
  timeoutMs: 10000,
};