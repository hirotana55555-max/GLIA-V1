# GLIA-V1 プロジェクト仕様書（完成版 - 更新）

## 基本情報
- プロジェクト名：GLIA (Generative Language Integration Assistant)
- バージョン：V1.0
- 目的：AI依存開発におけるプロンプト最適化とLLM出力制御
- **設計哲学**：**強力な自動化はPlaywrightに委譲、確実なリソース管理は堅牢な設計で実装**

## コア機能
1.  構造化JSON管理：プロジェクトルール、命名規則、ガードレールなどをJSON形式で保存
2.  プロンプト合成：自然言語と構造化JSONを最適な形式で合成
3.  自動投入：合成プロンプトを複数LLMサービスに自動投入
4.  出力取得：LLM出力をクリップボードにコピー

## **更新：技術アーキテクチャ（完全分離3.5層構造）**

### 第一層：Electronメインアプリ (`apps/electron-app`)
- ユーザーインターフェース
- フローティングウィンドウ管理
- モジュール統合制御
- **追加責務**：**アプリケーションライフサイクル（起動/終了）に連動した、全リソースの確実な初期化と解放のトリガー。**

### 第二層：プロンプト合成エンジン (`packages/prompt-core`)
- 構造化JSON管理
- プロンプトテンプレート処理
- 合成ロジック（UI非依存）
- （変更なし）

### **第三層：ブラウザリソースマネージャー (`packages/browser-manager`) 【新設】**
- **責務**：Playwrightブラウザ・コンテキスト・ページインスタンスの**ライフサイクルを一元管理**し、メモリリークを防止する。
- **中核設計思想**：
    1.  **明示的なライフサイクル管理**：`try...finally` パターンやコンテキストマネージャーを用い、あらゆる正常/異常終了パスにおいてリソース（ブラウザプロセス、ページ）の解放を保証する。
    2.  **能動的メモリ監視（プロファイリング）**：Playwright経由でChrome DevTools Protocol(CDP)にアクセスし、`JSHeapUsedSize` 等のメトリクスを定期的に取得・記録。閾値超過でアラートを発し、メモリリークの早期検知を可能とする。
    3.  **セッションの安定化**：長時間運用によるメモリ断片化を防ぐため、一定時間または一定使用後のコンテキストを自動再起動する「定期的なリフレッシュ」メカニズムを備える。
- **提供API**：マネージャーを通じて取得した、管理対象の `BrowserContext` または `Page` インスタンス。

### **第四層：ブラウザ自動化エージェント (`packages/browser-agent`) 【責務変更】**
- **責務変更**：ブラウザの起動・管理から解放され、**マネージャーから提供されたPageインスタンスに対する「操作ロジックの実行」に特化**する。
- **マルチLLM対応**：DeepSeek、Claude、ChatGPT等、各サービス固有の操作をカプセル化するエンジンクラスを実装。
- **将来の拡張性**：**Page Object Model (POM) パターン**を採用する設計とし、各LLMサービスのページ構造（セレクタ）と操作を分離。これにより、ウェブUI変更時の修正箇所を局所化し、保守工数を最小化する。

## **更新：動作確認済み項目**
- GitHubリポジトリ作成とプロジェクト構造構築
- Electronアプリ最小構成の起動確認
- プロンプト合成エンジンの基本動作
- （旧）ブラウザ自動化エージェントの基本動作
- 3モジュールの独立動作確認
- 統合テスト成功（3モジュール連携可能）
- **追加項目**：**Playwrightを用いた基本的なブラウザ自動化（起動、ナビゲート、入力）の動作確認済み。**

## **更新：次の実装フェーズ**

### **フェーズ1：堅牢な基盤統合（優先度：高）**
1.  **`@glia/browser-manager` パッケージの新設**
    - `BrowserManager` シングルトンクラスの実装（リソースプール管理）
    - `ResourceLifecycle` ヘルパーの実装（`try...finally` パターンの構造化）
    - `MemoryProfiler` モジュールの実装（CDPを用いた基本的なメモリ監視）
2.  **Electronアプリとの統合**
    - `browser-integration.ts` の改修：IPCハンドラーが `@glia/browser-manager` のAPIを呼び出す。
    - `main.ts` へのアプリ終了ハンドラー追加：`app.on('before-quit')` で `browserManager.cleanup()` を呼び出し、確実に全ブラウザプロセスを終了。
3.  **`@glia/browser-agent` のリファクタリング（オプション）**
    - 操作エンジンのインターフェース（`BaseEngine`）定義。
    - `DeepSeekEngine` のプロトタイプ実装（マネージャーからPageを受け取り、操作する）。

### フェーズ2：拡張機能（優先度：中）
1.  JSONスキーマ管理UI
2.  **マルチLLM同時投入**：マネージャーによる複数ブラウザコンテキスト/タブの安定管理。
3.  **プロンプト履歴保存**：SQLite等を用いた即時保存機能を実装し、アプリクラッシュ時もデータ損失を防ぐ。

### フェーズ3：高度化（優先度：低）
1.  Obsidian連携
2.  API連携モジュール
3.  自律開発支援

## **更新：開発環境**
- Node.js：20.x
- TypeScript：5.x
- Electron：28.x
- **Playwright：1.40.x** （自動化の中核）

## **更新：ビルドとテスト方法**
各モジュール個別ビルド：
```bash
cd apps/electron-app && npm run build
cd packages/prompt-core && npm run build
cd packages/browser-manager && npm run build # 新規
cd packages/browser-agent && npm run build # 責務変更後
```
個別テスト：
```bash
cd apps/electron-app && npm start
cd packages/prompt-core && npm run test:basic
cd packages/browser-manager && npm run test:lifecycle # 新規（ライフサイクルテスト）
cd packages/browser-agent && npm run test:safe
```
統合テスト：
```bash
cd integration-test && node simple-integration.js
```
**追加テスト**：
```bash
cd integration-test && node test-resource-cleanup.js # リソース解放の堅牢性テスト
```

## **更新：プロジェクトロードマップ**
1.  **堅牢な基盤統合実装（2-3週間）**：`browser-manager` の完成とElectronアプリへの統合。
2.  コア機能拡張（2週間）：スキーマ管理、履歴保存。
3.  最適化と安定化（1-2週間）：メモリ監視の強化、エラーハンドリングの洗練。
4.  拡張機能開発（随時）：Obsidian連携、API連携。

## **更新：非エンジニア向け開発アプローチ**
- **AI依存開発**：各機能をカプセル化し、LLMによる段階的開発を可能に。本仕様書は異なるLLMセッション間での継続開発のための**唯一の情報源**とする。
- **完全分離設計**：モジュール間の依存関係を排除し、変更影響を最小化。**管理（manager）と操作（agent）の責務分離はこの原則の具現化である。**
- **仕様書駆動**：明確な仕様書をもとに、異なるLLMセッションで継続開発。
- **変更への耐性**：自動化ロジックは **Page Object Model (POM)** に準拠して実装し、ウェブUI変更に強い構造とする。

## **更新：主要なファイル変更概要**
| 種別 | 対象パッケージ/ディレクトリ | 主要な変更内容 | 影響ファイル数見積 |
| :--- | :--- | :--- | :--- |
| **新設** | `packages/browser-manager/` | リソース管理の中核。マネージャー、ライフサイクル、監視モジュール。 | **~6-8 ファイル** |
| **改変** | `apps/electron-app/` | 新マネージャーとの統合、アプリ終了ハンドラー追加。 | **~2-3 ファイル** |
| **進化** | `packages/browser-agent/` | 責務を「操作」に特化。エンジンインターフェースと実装。 | **~3-5 ファイル** (リファクタリング) |
| **新設/改変合計** | | | **~11-16 ファイル** |

**作成日**：2024年12月4日
**最終更新**：**2024年12月5日** (アーキテクチャの重要更新を反映)
**プロジェクト状態**：基盤構築完了、**次フェーズ「堅牢な基盤統合」の仕様確定、実装待機。**

---
この更新により、特に**第三層と第四層の責務分離と設計思想**が明確化され、他LLMによる監査や継続的な開発において、一貫した技術判断の基盤が提供されます。次の具体的な実装ステップに進む準備が整いました。