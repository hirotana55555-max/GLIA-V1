# GLIA-V1 プロジェクト仕様書（完成版 - 監査反映版）

## 基本情報
- プロジェクト名：GLIA (Generative Language Integration Assistant)
- バージョン：V1.0
- 目的：AI依存開発におけるプロンプト最適化とLLM出力制御
- 設計哲学：強力な自動化はPlaywrightに委譲、確実なリソース管理は堅牢な設計で実装
- 安定性目標：非エンジニア管理者による長時間運用を可能にする、自己治癒的で観測可能な基盤

## コア機能
1.  構造化JSON管理：プロジェクトルール、命名規則、ガードレールなどをJSON形式で保存
2.  プロンプト合成：自然言語と構造化JSONを最適な形式で合成
3.  自動投入：合成プロンプトを複数LLMサービスに自動投入
4.  出力取得：LLM出力をクリップボードにコピー

## 更新：技術アーキテクチャ（完全分離3.5層構造）

### 第一層：Electronメインアプリ (apps/electron-app)
- ユーザーインターフェース
- フローティングウィンドウ管理
- モジュール統合制御
- 追加責務：アプリケーションライフサイクル（起動/終了）に連動した、全リソースの確実な初期化と解放のトリガー。

### 第二層：プロンプト合成エンジン (packages/prompt-core)
- **責務**: ユーザーの自然言語入力と、事前定義された構造化ルール（JSONスキーマ）を結合し、LLMへの最適なプロンプト文字列を生成する。
- **中核設計思想**:
    1.  **UI非依存の純粋関数**: このパッケージはElectronやDOMに一切依存せず、入力データから出力文字列を生成するロジックのみを含む。
    2.  **スキーマ駆動**: プロジェクト固有の命名規則、コーディング規約、ガードレールなどをJSONスキーマとして管理し、プロンプトに自動反映する。
    3.  **合成のカスタマイズ性**: 異なるスキーマタイプや合成戦略（テンプレート）に対応可能な設計。
- **提供API**:
    - `synthesizePrompt(input: PromptInput): string`: メインの合成関数。
    - `createSampleSchema(): PromptSchema`: 開発・テスト用のサンプルスキーマ生成関数。
- **主要な型定義 (types.ts)**:
    ```typescript
    interface PromptSchema {
      id: string;
      name: string;
      content: Record<string, any>; // 構造化JSONルール
    }
    interface PromptInput {
      naturalLanguage: string;
      selectedSchemas: PromptSchema[];
    }
    ```
- **既存の実装状況**: `packages/prompt-core/src/index.ts` に上記APIの基本的な実装が存在する。現在は、スキーマの内容をJSONコードブロックとしてプロンプトに前置し、その後に自然言語のリクエストを結合するシンプルな合成ロジックを提供している。
- **次の拡張フェーズ**:
    1.  スキーマのバージョン管理と永続化（ファイル/DB）。
    2.  テンプレートエンジンの導入（より柔軟なプロンプトフォーマット）。
    3.  合成履歴の記録と再利用。
### 第三層：ブラウザリソースマネージャー (packages/browser-manager) 【新設・設計強化】
- 責務：Playwrightブラウザ・コンテキスト・ページインスタンスのライフサイクルを一元管理し、メモリリークを防止する。
- 中核設計思想（ChatGPT監査反映）：
    1.  明示的で確実なリソース解放：try...finally パターンと構造化された終了ロジックに加え、OSレベルの「ゴーストプロセス」検出・終了ルーチンを定期的に実行する。
    2.  予防的リソースリサイクル戦略：単なる使用中監視を超え、「最大アイドル時間」「最大リクエスト数」「定期強制再起動」のポリシーに基づき、ブラウザコンテキストを自動的にリフレッシュし、状態の「汚染」とメモリの断片化を防止する。
    3.  多層的な監視（Observability）：
        - JSヒープ：Chrome DevTools Protocol (CDP) による JSHeapUsedSize の監視と閾値アラート。
        - OSプロセス：Playwrightが生成した子プロセスのメモリ（RSS）監視と異常終了。
        - 状態健全性：セッションのCookie/ローカルストレージの意図しない増大を検知。
    4.  クリーンな分離保証：重要な操作の前や、再利用セッション取得時に、必要に応じて完全にクリーンな新しいコンテキストを提供するオプションを用意し、テストの分離性（Isolation）に準拠する。
- 提供API：マネージャーを通じて取得した、管理対象の BrowserContext または Page インスタンス。

### 第四層：ブラウザ自動化エージェント (packages/browser-agent) 【責務変更・設計強化】
- 責務変更：ブラウザの起動・管理から解放され、マネージャーから提供されたPageインスタンスに対する「操作ロジックの実行」に特化する。
- マルチLLM対応：DeepSeek、Claude、ChatGPT等、各サービス固有の操作をカプセル化するエンジンクラスを実装。
- 将来の拡張性：Page Object Model (POM) パターンを採用する設計とし、各LLMサービスのページ構造（セレクタ）と操作を分離。これにより、ウェブUI変更時の修正箇所を局所化し、保守工数を最小化する。
- 安定性強化（ChatGPT監査反映）：
    1.  操作の健全性チェック：各操作実行前に、対象ページのUI状態が期待通りか自動検証。
    2.  エラー回復戦略：要素検索失敗やタイムアウトなどに備えた、段階的なリトライとコンテキスト再取得ロジック。
    3.  詳細なトレース記録：デバッグのため、操作ステップごとのスクリーンショットやログを自動取得可能に。

## 更新：動作確認済み項目
- GitHubリポジトリ作成とプロジェクト構造構築
- Electronアプリ最小構成の起動確認
- プロンプト合成エンジンの基本動作
- （旧）ブラウザ自動化エージェントの基本動作
- 3モジュールの独立動作確認
- 統合テスト成功（3モジュール連携可能）
- 追加項目：Playwrightを用いた基本的なブラウザ自動化（起動、ナビゲート、入力）の動作確認済み。

## 更新：次の実装フェーズ（監査反映）

### フェーズ1：堅牢な基盤統合（優先度：高）
1.  @glia/browser-manager パッケージの新設（監査反映版）
    - BrowserManager シングルトンクラス：リサイクルポリシー（最大アイドル時間、リクエスト数制限）を実装したリソースプール管理。
    - ResourceLifecycle ヘルパー：try...finally パターンの構造化に加え、OSレベル残留プロセス検出の枠組みを準備。
    - MemoryProfiler モジュール：CDPを用いた多層的監視（JSヒープ、プロセスメモリ）の基本実装。
2.  Electronアプリとの統合
    - browser-integration.ts の改修：IPCハンドラーが @glia/browser-manager のAPIを呼び出し、クリーンコンテキストオプションを利用可能に。
    - main.ts へのアプリ終了ハンドラー追加：app.on('before-quit') で browserManager.cleanupAll('critical') を呼び出し、確実に全ブラウザプロセスを終了。
3.  @glia/browser-agent のリファクタリング
    - 操作エンジンの基底インターフェース（BaseEngine）定義：健全性チェック(healthCheck)、エラー回復(recoverFromError)メソッドを追加。
    - DeepSeekEngine のプロトタイプ実装：マネージャーからPageを受け取り、リサイクルポリシーを考慮した操作を実行。

### フェーズ2：拡張機能と観測性の強化（優先度：中）
1.  JSONスキーマ管理UI
2.  マルチLLM同時投入：マネージャーによる複数ブラウザコンテキスト/タブの安定管理と、状態汚染を防ぐ分離ポリシーの実装。
3.  プロンプト履歴保存：SQLiteを用いた即時保存機能を実装し、アプリクラッシュ時もデータ損失を防ぐ。
4.  高度な監視と通知：メモリ閾値超過時の自動アラート通知（Electron UI内）と、CDPヒープスナップショット取得機能の追加。

### フェーズ3：高度化（優先度：低）
1.  Obsidian連携
2.  API連携モジュール
3.  自律開発支援

## 更新：開発環境
- Node.js：20.x
- TypeScript：5.x
- Electron：28.x
- Playwright：1.40.x （自動化の中核）

## 更新：ビルドとテスト方法
各モジュール個別ビルド：
cd apps/electron-app && npm run build
cd packages/prompt-core && npm run build
cd packages/browser-manager && npm run build # 新規
cd packages/browser-agent && npm run build # 責務変更後

個別テスト：
cd apps/electron-app && npm start
cd packages/prompt-core && npm run test:basic
cd packages/browser-manager && npm run test:lifecycle # 新規（ライフサイクルテスト）
cd packages/browser-agent && npm run test:safe

統合テスト：
cd integration-test && node simple-integration.js

追加テスト（監査反映）：
cd integration-test && node test-resource-cleanup.js # リソース解放の堅牢性テスト
cd integration-test && node test-recycling-policy.js # リサイクルポリシーの動作確認

## 更新：プロジェクトロードマップ
1.  堅牢な基盤統合実装（2-3週間）：browser-manager （監査反映版）の完成とElectronアプリへの統合。
2.  コア機能拡張と観測性強化（2-3週間）：スキーマ管理、履歴保存、および多層的監視・アラート機能の実装。
3.  最適化と安定化（1-2週間）：メモリ監視の強化、エラーハンドリングの洗練、非エンジニア向け運用手順書の作成。
4.  拡張機能開発（随時）：Obsidian連携、API連携。

## 更新：非エンジニア向け開発アプローチ
- AI依存開発：各機能をカプセル化し、LLMによる段階的開発を可能に。本仕様書は異なるLLMセッション間での継続開発のための唯一の情報源とする。
- 完全分離設計：モジュール間の依存関係を排除し、変更影響を最小化。管理（manager）と操作（agent）の責務分離はこの原則の具現化である。
- 仕様書駆動：明確な仕様書をもとに、異なるLLMセッションで継続開発。
- 変更への耐性：自動化ロジックは Page Object Model (POM) に準拠して実装し、ウェブUI変更に強い構造とする。
- 運用の可視化：ログ、監視、アラート、手動リセット手順をドキュメント化し、非エンジニア管理者がシステムの健全性を把握・維持できるようにする。

## 更新：主要なファイル変更概要
| 種別 | 対象パッケージ/ディレクトリ | 主要な変更内容 | 影響ファイル数見積 |
| :--- | :--- | :--- | :--- |
| 新設 | packages/browser-manager/ | リソース管理の中核。リサイクルポリシー、多層監視、OSレベルクリーンアップ枠組みを含む。 | ~8-10 ファイル |
| 改変 | apps/electron-app/ | 新マネージャーとの統合、アプリ終了ハンドラー追加、クリーンコンテキストオプションの提供。 | ~2-3 ファイル |
| 進化 | packages/browser-agent/ | 責務を「操作」に特化。健全性チェック、エラー回復戦略を備えたエンジンインターフェースと実装。 | ~4-6 ファイル (リファクタリング) |
| 新設/改変合計 | | | ~14-19 ファイル |

作成日：2024年12月4日
最終更新：2024年12月5日 (ChatGPT監査結果を反映したアーキテクチャの重要更新)
プロジェクト状態：基盤構築完了、次フェーズ「堅牢な基盤統合（監査反映版）」の仕様確定、実装待機。

---
この更新により、ChatGPT監査で指摘された「リソース解放の不十分さ」「コンテキスト再利用のリスク」「UI変更への脆弱性」「モニタリングの限定的さ」という主要な懸念点に対処する設計が明文化されました。次の具体的な実装ステップに進む準備が整っています。
